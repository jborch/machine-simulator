<div class="flex gap-2 mb-4 items-center">
  <button
    data-testid="run-btn"
    class="rounded border border-gray-300 bg-white px-4 py-1.5 text-sm disabled:opacity-50 disabled:cursor-default cursor-pointer"
    [disabled]="isRunning() || !connected()"
    (click)="onRun()"
  >
    Run
  </button>
  <button
    data-testid="stop-btn"
    class="rounded border border-gray-300 bg-white px-4 py-1.5 text-sm disabled:opacity-50 disabled:cursor-default cursor-pointer"
    [disabled]="!isRunning() || !connected()"
    (click)="onStop()"
  >
    Stop
  </button>
  <button
    data-testid="reset-btn"
    class="rounded border border-gray-300 bg-white px-4 py-1.5 text-sm disabled:opacity-50 disabled:cursor-default cursor-pointer"
    [disabled]="!connected()"
    (click)="onReset()"
  >
    Reset
  </button>
  <span class="flex items-center gap-1 ml-4">
    @for (speed of speeds; track speed.label) {
      <button
        class="rounded border px-2 py-0.5 text-xs cursor-pointer"
        [class.border-blue-500]="activeSpeed() === speed.label"
        [class.bg-blue-50]="activeSpeed() === speed.label"
        [class.text-blue-700]="activeSpeed() === speed.label"
        [class.border-gray-300]="activeSpeed() !== speed.label"
        [class.bg-white]="activeSpeed() !== speed.label"
        [disabled]="!connected()"
        (click)="onSpeed(speed)"
      >
        {{ speed.label }}
      </button>
    }
  </span>
  <span class="flex items-center gap-1.5 text-xs text-gray-500 ml-2">
    <span
      class="inline-block w-2 h-2 rounded-full"
      [class.bg-green-500]="connected()"
      [class.bg-red-400]="!connected()"
    ></span>
    {{ connected() ? 'Connected' : 'Disconnected' }}
  </span>
</div>

<div
  class="grid grid-cols-[auto_1fr_auto] grid-rows-[auto_1fr_auto] gap-0 max-w-[900px]"
  data-testid="machine-loop"
>
  <!-- Top-left: Buffer -->
  <div class="col-start-1 row-start-1 flex flex-col items-center p-1">
    @if (buffer(); as d) {
      <div class="flex flex-col items-center rounded-md border-2 border-gray-500 bg-gray-50 p-2 min-w-20">
        <span class="text-xs font-semibold mb-1">Buffer</span>
        <div class="flex flex-wrap gap-0.5 justify-center">
          @for (i of [].constructor(d.queueLength); track $index) {
            <div class="size-3 rounded-full bg-gray-400"></div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Top edge: Buffer-DeNesting conveyor -->
  <div class="col-start-2 row-start-1 flex items-center p-1">
    @if (bufferDeNesting(); as d) {
      <app-conveyor [details]="d" orientation="horizontal" direction="forward" />
    }
  </div>

  <!-- Top-right: DeNesting + NestInfeed -->
  <div class="col-start-3 row-start-1 flex items-end gap-2 p-1">
    @if (deNesting(); as d) {
      <app-processing-station name="DeNesting" [details]="d" />
    }
    @if (nestInfeed(); as d) {
      <app-info-panel name="NestInfeed" [value]="d.pensDispensed" caption="pens dispensed" />
    }
  </div>

  <!-- Left edge: Packing-Buffer conveyor -->
  <div class="col-start-1 row-start-2 flex flex-col-reverse items-center p-1">
    @if (packingBuffer(); as d) {
      <app-conveyor [details]="d" orientation="vertical" direction="reverse" />
    }
  </div>

  <!-- Right edge: DeNesting-Capping, Capping, Capping-Reject, Reject -->
  <div class="col-start-3 row-start-2 row-span-2 flex flex-col items-start gap-1 p-1">
    @if (deNestingCapping(); as d) {
      <app-conveyor [details]="d" orientation="vertical" direction="forward" />
    }
    @if (capping(); as d) {
      <app-processing-station name="Capping" [details]="d" />
    }
    @if (cappingReject(); as d) {
      <app-conveyor [details]="d" orientation="vertical" direction="forward" />
    }
    @if (reject(); as d) {
      <app-processing-station name="Reject" [details]="d" />
    }
    @if (rejectBin(); as d) {
      <app-info-panel name="RejectBin" [value]="d.itemsRejected" caption="items rejected" />
    }
  </div>

  <!-- Bottom-left: Packing + CartonOutfeed -->
  <div class="col-start-1 row-start-3 flex items-start gap-2 p-1">
    @if (cartonOutfeed(); as d) {
      <app-info-panel name="CartonOutfeed" [value]="d.itemsReceived" caption="items received" />
    }
    @if (packing(); as d) {
      <app-processing-station name="Packing" [details]="d" />
    }
  </div>

  <!-- Bottom edge: Reject-Packing conveyor -->
  <div class="col-start-2 row-start-3 flex items-center p-1">
    @if (rejectPacking(); as d) {
      <app-conveyor [details]="d" orientation="horizontal" direction="reverse" />
    }
  </div>
</div>
